## QuickJS 内存管理机制设计

### 版本一

机制：

- 程序初始时手动申请一块虚拟机堆内存，后续交由虚拟机自主管理，不与系统交涉；程序终止时手动释放所有虚拟机内存资源。
- 内存管理通过位图机制实现，也是 OS 常用的内存管理方式。

优缺点：

- 好处是简单容易理解和实现；坏处是不够灵活，而且不存在分级管理导致空间开销大



### 版本二

机制：（建议结合代码理解）

- 同上，也是申请一大块内存交由 VM 管理。
- 内存管理采取**分块二级管理机制**：
  - 将堆进行分块处理，每个单位块的大小为 BLOCK_SIZE，依据需要申请的空间大小可以分配多个连续单位块作为一个块。这里所谓的块，在程序中对应 LiteJSBlock 结构体，其中记录每个块的信息。
  
  - 堆对应一个位图，来标记每个单位快是否在使用中；每个块也对应一个位图，来标记块内的空间使用情况。
  
  - 所有的 LiteJSBlock 结构体连接成链由 lite_js_block_head 作为头部节点串接保存。
  
    ![pic1](../../../Pictures/pic1-0049603.png)
